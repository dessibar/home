<!DOCTYPE html> 
<html class="home-bg">

<head>
  <title>DESSIBAR Project</title>
  <style>
      #map {
        position:center;
        height: 400px;
        width: 50%;
      }
  </style>
  <meta http-equiv="content-type" content="text/html; charset=windows-1252" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <!-- modernizr enables HTML5 elements and feature detects -->
  <script type="text/javascript" src="js/jquery.js"></script>
  <!-- <script type="text/javascript" src="js/modernizr-1.5.min.js"></script> -->

</head>

<body>
  
  

   <h1>Icelandic and Barents Sea Stock Visualization Tool</h1>
	 
   <p id="acousticText"></p>
   
   <input type="file" id="files" name="files[]" multiple />
   <output id="list"></output>
	
   <div id="map"></div>
	
   <script>
	   
     var map;
	   
     function initMap(){
        var options = {
            zoom:6,
            center:{lat:62.641066,lng:-12.704159}
        }  
         
        var infowindow = new google.maps.InfoWindow();
      
        map = new google.maps.Map(document.getElementById('map'), options);
        
        
        google.maps.event.addListenerOnce(map, 'idle', function(){
        jQuery('.gm-style-iw').prev('div').remove();
        }); 
		
     }	   
	   
     function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object
        // files is a FileList of File objects. List some properties.
        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
        output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                  '</li>');
	        }
        document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
	loadXMLDoc(files);
									   
	}
	   
	function loadXMLDoc(fileArray) {
	console.log("LOAD XML DOC FUNCTION");
	console.log(fileArray[0]);
  	var xmlhttp = new XMLHttpRequest();
	xmlhttp.open("GET", "/home/acoustics/example.xml", true);
	xmlhttp.send();
  	xmlhttp.onreadystatechange = function() {
	 console.log("ReadyState: " + this.readyState);
	 console.log("Status: " + this.status);
   	 if (this.readyState == 4 && this.status == 200) {
   	   myFunction(this);
  	  }
 	 }; 
	}
	   
	function myFunction(xml) {
	console.log("ENTRO A LA FUNCION");
  	var stockNumber, latLng, x, y, i, xmlDoc, txt;
 	xmlDoc = xml.responseXML;
	console.log(xml.responseXML);
  	txt = "";
  	x = xmlDoc.getElementsByTagName("lat_start");
	y = xmlDoc.getElementsByTagName("lon_start");
	z = xmlDoc.getElementsByTagName("sa");
  	for (i = 0; i< x.length; i++) {
  	  txt += x[i].childNodes[0].nodeValue + "<br>";
	  txt += y[i].childNodes[0].nodeValue + "<br>";
          txt += z[i].childNodes[0].nodeValue + "<br>";
          console.log(x[i].childNodes[0].nodeValue + "<br>");
	  console.log(y[i].childNodes[0].nodeValue + "<br>");
	  console.log(z[i].childNodes[0].nodeValue + "<br>");
		
	  stocknumber = z[i].childNodes[0].nodeValue;
		
	  latLng = {
           lat: Number(x[i].childNodes[0].nodeValue),
           lng: Number(y[i].childNodes[0].nodeValue)
          };
		
          addMarker(stockNumber, latLng); 
  	}

  	document.getElementById("acousticText").innerHTML = txt;
	
	}
	     
	document.getElementById('files').addEventListener('change', handleFileSelect, false);

        
      function addMarker(stock,latLng){
        var marker = new google.maps.Marker({
          position:latLng,
          icon:'https://raw.githubusercontent.com/dessibar/home/master/images/capelin-green-tilted.png',
          setMap:map,
        });
	      
	console.log("MARKER ADDED!");
        
        var content = '<div id="content">'+
      '<div id="bodyContent">'+
      '<div id="positionContent"><p>Position: ' + String(latLng['lat']) + ", " + String(latLng['lng']) + '</p></div>' +
      '<div id="stockContent"><p>Capelin Stock: ' + stock + '</p></div>' 
      '</div>'+
      '</div>';                     
        
        google.maps.event.addListener(marker,'click', (function(marker,content,infowindow){ 
        return function() {
          infowindow.setContent(content);
          infowindow.open(map,this);
          };
		
	/*	
		
        $infoWindowContent.width($infoWindowContent.width());
        })(marker,content,infowindow));
	
	*/
   
        google.maps.event.addListener(marker, 'click', function() {
          infowindow.open(map,marker);
        });
        // Event that closes the Info Window with a click on the map
        google.maps.event.addListener(map, 'click', function() {
        infowindow.close();
        });
  	}    
	   
   </script>


   <script async defer 
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD27I7bId1Hmqthv5gTTh15GKAgkiFM538&callback=initMap">
      </script>
  
</body>
</html>
