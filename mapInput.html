<!DOCTYPE html> 
<html class="home-bg">

<head>
  <title>DESSIBAR Project</title>
  <style>
      #map {
        position:center;
        height: 400px;
        width: 50%;
      }
  </style>
  <meta http-equiv="content-type" content="text/html; charset=windows-1252" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <!-- modernizr enables HTML5 elements and feature detects -->
  <script type="text/javascript" src="js/jquery.js"></script>
  <!-- <script type="text/javascript" src="js/modernizr-1.5.min.js"></script> -->

</head>

<body>
  
   <h1>Icelandic and Barents Sea Stock Visualization Tool</h1>
	 
   <p id="acousticText"></p>
   <button onclick="loadXMLDoc('Svalbard')">Svalbard Sample</button>
   <button onclick="loadXMLDoc('Iceland')">Icelandic Sample</button>
   <div id="map"></div>
	
   <script> 
	   
	var markers = [];
	var map;
	var infoWindow;
	var maxLat;
	var maxLong;
        var minLat;
	var minLong;
	   
	function loadXMLDoc(location) {
	console.log("LOAD XML DOC FUNCTION");
  	var xmlhttp = new XMLHttpRequest();
	if (location == "Svalbard"){
	xmlhttp.open("GET", "/home/acoustics/JH_LCS.txt.xml", true);
	}
	else if (location == "Iceland") {
	xmlhttp.open("GET", "/home/acoustics/Icelandic.txt.xml", true);
	}
	xmlhttp.send();
  	xmlhttp.onreadystatechange = function() {
   	 if (this.readyState == 4 && this.status == 200) {
   	   myFunction(this);
  	  }
 	 }; 
	}
	   
	function myFunction(xml) {
  	var stockNumber, latLng, distanceArray, latData, lonData, saData, i, j, xmlDoc, txt;
 	xmlDoc = xml.responseXML;
	deleteMarkers();
	maxLat = 0;
	maxLong = 0;
        minLat = 999999;
	minLong = 999999;
  	txt = "";
		
	console.log("Primer Long: " + distanceArray[0].getElementsByTagName("lon_start")[0].childNodes[0].nodeValue)
	if (distanceArray[0].getElementsByTagName("lon_start")[0].childNodes[0].nodeValue > 0) {
	   maxLong = 0;
	}
	else {
	   maxLong = -999999;
	}
	
  	distanceArray = xmlDoc.getElementsByTagName("distance");

  	for (i = 0; i < distanceArray.length; i++) {
	  stockDate = distanceArray[i].getAttribute("start_time");
  	  latData = distanceArray[i].getElementsByTagName("lat_start");
	  console.log(latData[0].childNodes[0].nodeValue);
	  lonData = distanceArray[i].getElementsByTagName("lon_start");
	  console.log(lonData[0].childNodes[0].nodeValue);
   	  saData = distanceArray[i].getElementsByTagName("sa");
	
	  for (j = 0; j < saData.length; j++) {
	    if (saData[j].parentNode.getAttribute("acocat") == "16") {
		stocknumber = saData[j].childNodes[0].nodeValue;
		    
		latLng = {
                   lat: Number(latData[0].childNodes[0].nodeValue),
                   lng: Number(lonData[0].childNodes[0].nodeValue)
                };
		    
		if (Number(latData[0].childNodes[0].nodeValue) > maxLat) {
		   maxLat = Number(latData[0].childNodes[0].nodeValue);
		}
		else if (Number(latData[0].childNodes[0].nodeValue) < minLat) {
		   minLat = Number(latData[0].childNodes[0].nodeValue);
		}
		if (Number(lonData[0].childNodes[0].nodeValue) > maxLong) {
		   maxLong = Number(lonData[0].childNodes[0].nodeValue);
		}
		if (Number(lonData[0].childNodes[0].nodeValue) < minLong) {
		   minLong = Number(lonData[0].childNodes[0].nodeValue);
		}
		    
		if (saData[j].childNodes[0].nodeValue < 50) {
   		   var capelinImage = {
                      url: 'https://raw.githubusercontent.com/dessibar/home/master/images/capelin-green-tilted.png',
                      scaledSize: new google.maps.Size(30, 30)
		   }
		}
		else if (saData[j].childNodes[0].nodeValue < 100) {
   		   var capelinImage = {
                      url: 'https://raw.githubusercontent.com/dessibar/home/master/images/capelin-yellow-tilted.png',
                      scaledSize: new google.maps.Size(30, 30)
                   }
		}
		else {
   		   var capelinImage = {
                      url: 'https://raw.githubusercontent.com/dessibar/home/master/images/capelin-red-tilted.png',
                      scaledSize: new google.maps.Size(30, 30)
                   }
		}
		
	        addMarker(capelinImage,stocknumber,stockDate,latLng);
	    }
	  }          
		
	}
	
	console.log("maxLat = " + maxLat);
	console.log("minLat = " + minLat);
	console.log("maxLong = " + maxLong);
	console.log("minLong = " + minLong);
	
	
	moveToLocation((maxLat+minLat)/2,(maxLong+minLong)/2);
		
	document.getElementById("acousticText").innerHTML = txt;
	
     }

	   
     function initMap(){
        var options = {
            zoom:5,
            center:{lat:62.641066,lng:-12.704159}
        }  
         
	infoWindow = new google.maps.InfoWindow();
        map = new google.maps.Map(document.getElementById('map'), options);
	   
      google.maps.event.addListenerOnce(map, 'idle', function(){
      jQuery('.gm-style-iw').prev('div').remove();
      }); 

     }
        
      function addMarker(image,stock,date,latLng){
        var marker = new google.maps.Marker({
          position:latLng,
          icon:image,
          map:map,
        });
        
	     
	      
        var content = '<div id="content">'+
      '<div id="bodyContent">'+
      '<div id="dateContent"><p>Date: ' + date + '</p></div>' +
      '<div id="positionContent"><p>Position: ' + String(latLng['lat']) + ", " + String(latLng['lng']) + '</p></div>' +
      '<div id="stockContent"><p>Capelin Stock: ' + stock + '</p></div>' 
      '</div>'+
      '</div>';                     
        
        google.maps.event.addListener(marker,'click', (function(marker,content,infoWindow){ 
        return function() {
          infoWindow.setContent(content);
          infoWindow.open(map,this);
          };
        $infoWindowContent.width($infoWindowContent.width());
        })(marker,content,infoWindow));
       
        google.maps.event.addListener(marker, 'click', function() {
          infoWindow.open(map,marker);
        });

        // Event that closes the Info Window with a click on the map
        google.maps.event.addListener(map, 'click', function() {
        infoWindow.close();
        });
	      
	markers.push(marker);
	
  	}    
	   
	function setMapOnAll(map) {
          for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
          }
        }
	   
	function clearMarkers() {
          setMapOnAll(null);
        }
	   
	function showMarkers() {
          setMapOnAll(map);
        }
	   
	function deleteMarkers() {
          clearMarkers();
          markers = [];
        }
	   
	function moveToLocation(lat, lng){
        var center = new google.maps.LatLng(lat, lng);
        map.panTo(center);
        }
	     
				 
							 
							 
   </script>


   <script async defer 
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD27I7bId1Hmqthv5gTTh15GKAgkiFM538&callback=initMap">
      </script>
  
</body>
</html>
